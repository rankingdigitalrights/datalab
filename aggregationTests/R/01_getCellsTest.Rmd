---
title: "R Notebook"
output: html_notebook
---

```{r}
# library(googlesheets)
# devtools::install_github("tidyverse/googlesheets4")
library(googlesheets4)
library(tidyverse)
library(googledrive)
```

```{r}
# token <- googlesheets::gs_auth()

```

```{r}
# spreadsheetID <- gs_key("1EBq-jrwx_P_908aMaVaOup08p0Ii2UsJ-upPRM3EK5Y")
# token <- googlesheets4::sheets_auth()
# save(token, file = "googleAuthToken.RData")
load("googleAuthToken.RData")
```

```{r}
if(!dir.exists("store")) dir.create("store")
```

## Fetch Meta

```{r}
pilot_id_dc <- "1eRzRqGy_baoheL8uxuh2fsMNuXicXAqOzvoLDlS6-Ak" # Etisalat Data Colelction MLS from 2019-09-17
pilot_meta_dc <- googlesheets4::sheets_get(pilot_id_dc)

pilot_meta_dc_names <- pilot_meta_dc$named_ranges
```

## Obsolete

```{r}
# spreadsheetObj <- gs_read_cellfeed(spreadhsheetID)

# pilot_sc <- map(pilot_id_sc, ~googlesheets4::sheets_read(.x))

# Killer generic approach: get all sheets from spreadsheet
# Needed: pilot ss id & sheet names
pilot_dc_raw <- map2(.x = pilot_meta_dc$spreadsheet_id,
                 .y = pilot_meta_dc$sheets$name,
                 .id = pilot_meta_dc$sheets$name,
                 ~googlesheets4::read_sheet(ss = .x, sheet = .y, skip = 0))

save(pilot_dc_raw, file = "store/pilot_apple_input_raw.RData")
load(file = "store/pilot_apple_input_raw.RData")
```

## Named Ranges

> Suuuuuper slow

```{r}
pilot_dc_ranges_raw <- map2(.x = pilot_meta_dc$spreadsheet_id,
                 .y = pilot_meta_dc$named_ranges$name,
                 .id = pilot_meta_dc$sheets$name,
                 ~googlesheets4::read_sheet(ss = .x, range = .y, skip = 0))
```

## raw cells

> first is not sufficient, second is as sloooow as the other named range approach

```{r}
g1_cells <- sheets_cells(ss = pilot_meta_dc$spreadsheet_id, sheet = 5)
cells <- map(pilot_meta_dc_names$name, ~sheets_cells(ss = pilot_meta_dc$spreadsheet_id, range = .x))
```

```{r}
g1_cells %>% hoist(.col = "cell", .simplify = TRUE)
# g1_cells %>% pluck(col = "cell")
g1_cells %>% unnest_wider(col = "cell")
g1_cells %>% unnest(col = cell)
```

```{r}
g1_cells %>% 
  mutate_if(is.list, map, as_data_frame) %>% 
  unnest_wider()
```

> worth keeping in mind

+ `googledrive::drive_upload(path = backendid, type = "spreadsheet`
